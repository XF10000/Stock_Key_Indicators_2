# 开发流程和阶段划分

## 1. 阶段概览

| 阶段 | 名称 | 依赖 | 核心交付物 |
| :--- | :--- | :--- | :--- |
| **阶段 0** | **项目脚手架与数据模型** | 无 | 完整的项目目录结构、`pyproject.toml` 配置文件、`models.py` |
| **阶段 1** | **核心数据管道原型验证** | 阶段 0 | 可运行的 `prototype.ipynb`，验证数据获取、存储、计算的核心流程 |
| **阶段 2** | **健壮的数据更新器** | 阶段 1 | 功能完整的 `data_updater.py`，包含断点续传和缓存失效逻辑 |
| **阶段 3** | **核心分析与计算引擎** | 阶段 1 | 包含所有指标计算方法的 `calculator.py` 和 `analyzer.py`，附带完整的单元测试 |
| **阶段 4** | **主程序与可视化** | 阶段 2, 3 | 可执行的 `main.py`，`Orchestrator`，以及 `plotter.py`，完成端到端的分析与图表生成 |

## 2. 阶段详细说明

### 阶段 0: 项目脚手架与数据模型

-   **开发要求**:
    1.  创建完整的项目目录结构 (`data_provider/`, `analysis/`, `visualization/`, `tests/`, `docs/`)。
    2.  创建 `pyproject.toml` 文件并配置 `black`, `flake8`, `mypy`。
    3.  创建 `requirements.txt` 文件并列出核心依赖。
    4.  实现 `models.py`，包含 `BalanceSheet`, `IncomeStatement`, `CashFlowStatement`, `IndicatorMedian` 四个表的 SQLAlchemy 模型定义。
-   **测试要求**: 此阶段不涉及逻辑代码，无需编写测试。
-   **验收标准**:
    -   [ ] 目录结构符合《架构设计文档》。
    -   [ ] `pyproject.toml` 配置正确，代码质量工具可运行。
    -   [ ] `models.py` 中的表定义与《架构设计文档》一致。
    -   [ ] 代码已通过审查。

---

### 阶段 1: 核心数据管道原型验证

-   **开发要求**:
    1.  创建 `prototype.py` 原型验证脚本。
    2.  实现《原型验证方案》中描述的所有步骤：获取数据、标准化列名、存入数据库、读出数据、计算 ROE。
    3.  完善 `column_mapping.yaml` 配置文件，添加 akshare 返回的英文列名映射。
-   **测试要求**: 所有验证逻辑均在 `prototype.py` 中完成，通过运行脚本输出验证结果。
-   **验收标准**:
    -   [x] `prototype.py` 能无错误地运行完成。
    -   [x] `database_test.sqlite` 文件被成功创建，数据符合预期。
    -   [x] 成功映射 30 个核心字段（stock_code, report_date, 资产/负债/权益等）。
    -   [x] 计算出的 ROE 值正确输出。
    -   [x] 成功测试多只股票的数据获取。
    -   [x] 代码已通过审查。

---

### 阶段 2: 健壮的数据更新器

-   **开发要求**:
    1.  创建 `utils/config_loader.py` 配置管理器
    2.  创建 `utils/logger.py` 日志系统和数据质量报告生成器
    3.  实现 `AkshareClient` 类（支持超时、重试、限流）
    4.  实现 `Repository` 类（线程安全的数据库操作）
    5.  创建 `data_updater_robust.py` 主程序，实现：
        - **超时机制**: API调用30秒超时，避免长时间挂起
        - **批次暂停**: 每N只股票暂停M秒，防止API限流
        - **断点续传**: 实时保存进度到JSON文件，支持中断后继续
        - **并发处理**: 使用线程池提升效率（10线程约6小时完成5000只股票）
        - **优雅退出**: Ctrl+C时完成当前批次后退出
-   **测试要求**:
    -   **功能测试**: 使用 `test_data_updater.py` 测试3只股票的完整流程
    -   **并发测试**: 使用 `data_updater_concurrent.py` 测试5只股票的并发性能
    -   **健壮性测试**: 使用 `data_updater_robust.py` 测试10只股票的超时、暂停、续传功能
-   **验收标准**:
    -   [x] `python data_updater_robust.py` 可以成功运行并将数据写入数据库
    -   [x] 实现超时机制，API调用超过30秒自动超时
    -   [x] 实现批次暂停，每50只股票暂停30秒（可配置）
    -   [x] 实现断点续传，进度保存到 `progress_robust.json`
    -   [x] 手动中断（Ctrl+C）后，再次运行能从断点处继续
    -   [x] 并发处理性能提升7倍以上（5线程：4.84秒/股 vs 串行：34.84秒/股）
    -   [x] 生成数据质量报告，记录成功率、失败股票、未映射列名
    -   [x] 代码已通过审查并提交到Git

---

### 阶段 3: 核心分析与计算引擎

-   **开发要求**:
    1.  在 `analysis/calculator.py` 中实现所有财务指标的计算方法。
    2.  在 `analysis/analyzer.py` 中实现市场中位数和历史分位数的计算，并包含缓存逻辑。
-   **测试要求**:
    -   **单元测试**: 为 `calculator.py` 和 `analyzer.py` 中的每个公共方法编写详细的测试用例，覆盖正常、异常和边缘情况。
-   **验收标准**:
    -   [ ] 所有指标的计算逻辑经过验证，结果准确。
    -   [ ] 中位数缓存机制按预期工作。
    -   [ ] 所有相关单元测试通过。
    -   [ ] 代码已通过审查。

---

### 阶段 4: 主程序与可视化

-   **开发要求**:
    1.  创建 `main.py` 主程序入口，处理命令行参数。
    2.  实现 `Orchestrator` 类，串联完整的分析流程，并处理数据库为空的情况。
    3.  实现 `visualization/plotter.py`，生成符合《需求澄清报告》要求的图表。
-   **测试要求**:
    -   **集成测试**: 针对 `Orchestrator` 的核心分析流程进行测试。
-   **验收标准**:
    -   [ ] `python main.py --code <stock_code>` 可以成功运行，并生成正确的图表文件。
    -   [ ] 当数据库为空时，程序能给出清晰的提示并退出。
    -   [ ] 所有相关集成测试通过。
    -   [ ] 代码已通过审查。

## 3. 待确认事项

-   无
