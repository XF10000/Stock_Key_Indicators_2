# æ•°æ®æ›´æ–°å™¨æ”¹è¿›è¯´æ˜

## æ”¹è¿›ç‰ˆæœ¬å¯¹æ¯”

| ç‰ˆæœ¬ | æ–‡ä»¶å | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|--------|------|----------|
| **ä¸²è¡Œç‰ˆ** | `data_updater.py` | å•çº¿ç¨‹ï¼Œé¡ºåºå¤„ç† | æµ‹è¯•ã€è°ƒè¯• |
| **å¹¶å‘ç‰ˆ** | `data_updater_concurrent.py` | å¤šçº¿ç¨‹å¹¶å‘ | å¿«é€Ÿæ›´æ–° |
| **å¥å£®ç‰ˆ** | `data_updater_robust.py` | å¹¶å‘+è¶…æ—¶+æ‰¹æ¬¡æš‚åœ+æ–­ç‚¹ç»­ä¼  | **ç”Ÿäº§ç¯å¢ƒæ¨è** |

## å¥å£®ç‰ˆä¸‰å¤§æ ¸å¿ƒæ”¹è¿›

### 1. è¶…æ—¶æœºåˆ¶ â±ï¸

**é—®é¢˜**: APIè°ƒç”¨å¯èƒ½é•¿æ—¶é—´æŒ‚èµ·ï¼Œå¯¼è‡´ç¨‹åºå¡æ­»

**è§£å†³æ–¹æ¡ˆ**:
```python
# AkshareClient æ·»åŠ  timeout å‚æ•°
client = AkshareClient(
    request_delay=0.1,
    retry_times=3,
    retry_delay=5.0,
    timeout=30.0  # 30ç§’è¶…æ—¶
)

# çº¿ç¨‹æ± ä»»åŠ¡ä¹Ÿè®¾ç½®è¶…æ—¶
result = future.result(timeout=70.0)  # æ¯”å†…éƒ¨è¶…æ—¶å¤š10ç§’
```

**æ•ˆæœ**: 
- APIè°ƒç”¨è¶…è¿‡30ç§’è‡ªåŠ¨è¶…æ—¶
- çº¿ç¨‹æ± ä»»åŠ¡è¶…è¿‡70ç§’å¼ºåˆ¶ç»ˆæ­¢
- é¿å…ç¨‹åºé•¿æ—¶é—´æŒ‚èµ·

### 2. æ‰¹æ¬¡æš‚åœ ğŸ›‘

**é—®é¢˜**: è¿ç»­å¤§é‡APIè¯·æ±‚å¯èƒ½è§¦å‘é™æµï¼Œå¯¼è‡´IPè¢«å°

**è§£å†³æ–¹æ¡ˆ**:
```python
# åˆ†æ‰¹å¤„ç†ï¼Œæ¯æ‰¹å¤„ç†å®Œåæš‚åœ
for batch_start in range(0, len(stock_infos), batch_size):
    batch = stock_infos[batch_start:batch_end]
    
    # å¤„ç†å½“å‰æ‰¹æ¬¡...
    process_batch(batch)
    
    # æ‰¹æ¬¡é—´æš‚åœ
    if batch_end < len(stock_infos):
        logger.info(f"æ‰¹æ¬¡å®Œæˆï¼Œæš‚åœ {batch_pause} ç§’...")
        time.sleep(batch_pause)
```

**é…ç½®å‚æ•°**:
- `--batch-size`: æ‰¹æ¬¡å¤§å°ï¼ˆé»˜è®¤50åªè‚¡ç¥¨ï¼‰
- `--batch-pause`: æ‰¹æ¬¡æš‚åœæ—¶é—´ï¼ˆé»˜è®¤30ç§’ï¼‰

**æ•ˆæœ**:
- æ¯å¤„ç†50åªè‚¡ç¥¨æš‚åœ30ç§’
- å¤§å¹…é™ä½APIé™æµé£é™©
- ç»™æœåŠ¡å™¨"å–˜æ¯"æ—¶é—´

### 3. æ–­ç‚¹ç»­ä¼  ğŸ’¾

**é—®é¢˜**: 5000åªè‚¡ç¥¨éœ€è¦æ•°å°æ—¶ï¼Œä¸­æ–­åéœ€è¦é‡å¤´å¼€å§‹

**è§£å†³æ–¹æ¡ˆ**:
```python
# è¿›åº¦è·Ÿè¸ªå™¨
class ProgressTracker:
    def __init__(self, progress_file: str = "progress.json"):
        self.processed_stocks = set()  # å·²å¤„ç†çš„è‚¡ç¥¨
        self.failed_stocks = {}        # å¤±è´¥çš„è‚¡ç¥¨
        self.load_progress()           # åŠ è½½ä¸Šæ¬¡è¿›åº¦
    
    def mark_processed(self, stock_code: str):
        """æ ‡è®°ä¸ºå·²å¤„ç†å¹¶ä¿å­˜"""
        self.processed_stocks.add(stock_code)
        self.save_progress()  # å®æ—¶ä¿å­˜
```

**è¿›åº¦æ–‡ä»¶** (`progress_robust.json`):
```json
{
  "processed": ["SH600519", "SZ300750", ...],
  "failed": {
    "SZ000001": "è¿æ¥è¶…æ—¶"
  },
  "last_update": "2026-01-24T20:04:21"
}
```

**æ•ˆæœ**:
- æ¯å¤„ç†å®Œä¸€åªè‚¡ç¥¨ç«‹å³ä¿å­˜è¿›åº¦
- ä¸­æ–­åé‡æ–°è¿è¡Œè‡ªåŠ¨è·³è¿‡å·²å¤„ç†è‚¡ç¥¨
- å¤±è´¥çš„è‚¡ç¥¨ä¼šè‡ªåŠ¨é‡è¯•

### 4. ä¼˜é›…é€€å‡º ğŸšª

**é—®é¢˜**: Ctrl+C å¼ºåˆ¶é€€å‡ºå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ**:
```python
# æ³¨å†Œä¿¡å·å¤„ç†å™¨
def signal_handler(signum, frame):
    global should_stop
    print("\næ”¶åˆ°ä¸­æ–­ä¿¡å·ï¼Œæ­£åœ¨ä¼˜é›…é€€å‡º...")
    should_stop = True

signal.signal(signal.SIGINT, signal_handler)

# å¤„ç†å¾ªç¯ä¸­æ£€æŸ¥åœæ­¢æ ‡å¿—
for batch in batches:
    if should_stop:
        logger.info("æ”¶åˆ°åœæ­¢ä¿¡å·ï¼Œé€€å‡ºå¤„ç†å¾ªç¯")
        break
```

**æ•ˆæœ**:
- Ctrl+C ä¸ä¼šç«‹å³é€€å‡º
- ç­‰å¾…å½“å‰æ‰¹æ¬¡å¤„ç†å®Œæˆ
- ä¿å­˜è¿›åº¦åä¼˜é›…é€€å‡º

## ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨
```bash
# ä½¿ç”¨é»˜è®¤é…ç½®ï¼ˆ10çº¿ç¨‹ï¼Œ50æ‰¹æ¬¡ï¼Œ30ç§’æš‚åœï¼‰
python data_updater_robust.py

# è‡ªå®šä¹‰é…ç½®
python data_updater_robust.py --workers 5 --batch-size 30 --batch-pause 20
```

### æµ‹è¯•æ¨¡å¼
```bash
# åªå¤„ç†å‰10åªè‚¡ç¥¨
python data_updater_robust.py --limit 10 --workers 3 --batch-size 3 --batch-pause 5
```

### æ–­ç‚¹ç»­ä¼ 
```bash
# ç¬¬ä¸€æ¬¡è¿è¡Œï¼ˆå¤„ç†äº†50åªåä¸­æ–­ï¼‰
python data_updater_robust.py
# Ctrl+C ä¸­æ–­

# ç¬¬äºŒæ¬¡è¿è¡Œï¼ˆè‡ªåŠ¨ä»ç¬¬51åªå¼€å§‹ï¼‰
python data_updater_robust.py
# è‡ªåŠ¨è·³è¿‡å·²å¤„ç†çš„50åªè‚¡ç¥¨
```

### é‡æ–°å¼€å§‹
```bash
# åˆ é™¤è¿›åº¦æ–‡ä»¶ï¼Œä»å¤´å¼€å§‹
rm progress_robust.json
python data_updater_robust.py

# æˆ–ä½¿ç”¨ --no-resume å‚æ•°
python data_updater_robust.py --no-resume
```

## æ€§èƒ½å¯¹æ¯”

### å¤„ç†10åªè‚¡ç¥¨çš„æµ‹è¯•ç»“æœ

| ç‰ˆæœ¬ | è€—æ—¶ | å¹³å‡/è‚¡ | å¹¶å‘æ•° | æ‰¹æ¬¡æš‚åœ |
|------|------|---------|--------|----------|
| ä¸²è¡Œç‰ˆ | ~350ç§’ | 35ç§’ | 1 | æ—  |
| å¹¶å‘ç‰ˆ(5çº¿ç¨‹) | ~48ç§’ | 4.8ç§’ | 5 | æ—  |
| å¥å£®ç‰ˆ(5çº¿ç¨‹) | ~60ç§’ | 6ç§’ | 5 | 5ç§’Ã—3æ‰¹æ¬¡ |

**è¯´æ˜**: å¥å£®ç‰ˆå› ä¸ºæ‰¹æ¬¡æš‚åœä¼šç¨æ…¢ï¼Œä½†æ¢æ¥äº†ç¨³å®šæ€§å’Œå®‰å…¨æ€§

### å…¨å¸‚åœº5000åªè‚¡ç¥¨é¢„ä¼°

| ç‰ˆæœ¬ | é¢„ä¼°è€—æ—¶ | é£é™© |
|------|----------|------|
| ä¸²è¡Œç‰ˆ | ~48å°æ—¶ | ä½ï¼ˆæ…¢ä½†ç¨³ï¼‰ |
| å¹¶å‘ç‰ˆ(10çº¿ç¨‹) | ~4å°æ—¶ | é«˜ï¼ˆå¯èƒ½è¢«é™æµï¼‰ |
| **å¥å£®ç‰ˆ(10çº¿ç¨‹)** | **~6å°æ—¶** | **ä½ï¼ˆæ¨èï¼‰** |

## é…ç½®å‚æ•°è¯´æ˜

### å‘½ä»¤è¡Œå‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--limit` | None | é™åˆ¶å¤„ç†çš„è‚¡ç¥¨æ•°é‡ï¼ˆæµ‹è¯•ç”¨ï¼‰ |
| `--workers` | 10 | å¹¶å‘çº¿ç¨‹æ•° |
| `--batch-size` | 50 | æ‰¹æ¬¡å¤§å°ï¼ˆæ¯Nåªè‚¡ç¥¨æš‚åœä¸€æ¬¡ï¼‰ |
| `--batch-pause` | 30.0 | æ‰¹æ¬¡æš‚åœæ—¶é—´ï¼ˆç§’ï¼‰ |
| `--no-resume` | False | ä¸ä½¿ç”¨æ–­ç‚¹ç»­ä¼ ï¼Œä»å¤´å¼€å§‹ |

### æ¨èé…ç½®

**ä¿å®ˆé…ç½®**ï¼ˆç¨³å®šä¼˜å…ˆï¼‰:
```bash
python data_updater_robust.py --workers 5 --batch-size 30 --batch-pause 60
```
- 5ä¸ªçº¿ç¨‹ï¼Œé™ä½å¹¶å‘å‹åŠ›
- æ¯30åªè‚¡ç¥¨æš‚åœ
- æš‚åœ60ç§’ï¼Œå……åˆ†ä¼‘æ¯

**å¹³è¡¡é…ç½®**ï¼ˆæ¨èï¼‰:
```bash
python data_updater_robust.py --workers 10 --batch-size 50 --batch-pause 30
```
- 10ä¸ªçº¿ç¨‹ï¼Œå¹³è¡¡é€Ÿåº¦å’Œç¨³å®šæ€§
- æ¯50åªè‚¡ç¥¨æš‚åœ
- æš‚åœ30ç§’

**æ¿€è¿›é…ç½®**ï¼ˆé€Ÿåº¦ä¼˜å…ˆï¼‰:
```bash
python data_updater_robust.py --workers 20 --batch-size 100 --batch-pause 15
```
- 20ä¸ªçº¿ç¨‹ï¼Œæœ€å¿«é€Ÿåº¦
- æ¯100åªè‚¡ç¥¨æš‚åœ
- æš‚åœ15ç§’
- âš ï¸ é£é™©ï¼šå¯èƒ½è§¦å‘APIé™æµ

## ç›‘æ§å’Œæ—¥å¿—

### æ—¥å¿—æ–‡ä»¶
- `logs/data_update_robust.log` - ä¸»æ—¥å¿—
- `logs/unmapped_columns.log` - æœªæ˜ å°„åˆ—å

### è¿›åº¦æ–‡ä»¶
- `progress_robust.json` - å®æ—¶è¿›åº¦

### ç›‘æ§å‘½ä»¤
```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
tail -f logs/data_update_robust.log

# æŸ¥çœ‹è¿›åº¦
cat progress_robust.json | jq '.processed | length'

# æŸ¥çœ‹å¤±è´¥è‚¡ç¥¨
cat progress_robust.json | jq '.failed'
```

## æ•…éšœå¤„ç†

### é—®é¢˜1: å¤§é‡è¶…æ—¶
**ç°è±¡**: æ—¥å¿—ä¸­å¤§é‡ "å¤„ç†è¶…æ—¶"
**åŸå› **: ç½‘ç»œä¸ç¨³å®šæˆ–APIå“åº”æ…¢
**è§£å†³**: 
- å‡å°‘å¹¶å‘æ•°: `--workers 3`
- å¢åŠ æ‰¹æ¬¡æš‚åœ: `--batch-pause 60`

### é—®é¢˜2: APIé™æµ
**ç°è±¡**: è¿”å› 429 é”™è¯¯æˆ–è¿æ¥è¢«æ‹’ç»
**åŸå› **: è¯·æ±‚è¿‡äºé¢‘ç¹
**è§£å†³**:
- å‡å°‘å¹¶å‘æ•°: `--workers 5`
- å‡å°æ‰¹æ¬¡: `--batch-size 20`
- å¢åŠ æš‚åœ: `--batch-pause 120`

### é—®é¢˜3: è¿›åº¦ä¸¢å¤±
**ç°è±¡**: é‡å¯åä»å¤´å¼€å§‹
**åŸå› **: è¿›åº¦æ–‡ä»¶æŸåæˆ–è¢«åˆ é™¤
**è§£å†³**:
- æ£€æŸ¥ `progress_robust.json` æ˜¯å¦å­˜åœ¨
- ä»æ•°æ®åº“æ¢å¤: ç¨‹åºä¼šè‡ªåŠ¨è·³è¿‡å·²æœ‰æ•°æ®

## æœ€ä½³å®è·µ

1. **é¦–æ¬¡è¿è¡Œ**: ä½¿ç”¨å°æ‰¹é‡æµ‹è¯•
   ```bash
   python data_updater_robust.py --limit 10 --workers 3
   ```

2. **æ­£å¼è¿è¡Œ**: ä½¿ç”¨æ¨èé…ç½®
   ```bash
   python data_updater_robust.py --workers 10 --batch-size 50
   ```

3. **å®šæœŸå¤‡ä»½**: å¤‡ä»½æ•°æ®åº“å’Œè¿›åº¦æ–‡ä»¶
   ```bash
   cp database.sqlite database_backup_$(date +%Y%m%d).sqlite
   cp progress_robust.json progress_backup.json
   ```

4. **ç›‘æ§è¿è¡Œ**: ä½¿ç”¨ tmux æˆ– screen ä¿æŒä¼šè¯
   ```bash
   tmux new -s stock_updater
   python data_updater_robust.py
   # Ctrl+B, D åˆ†ç¦»ä¼šè¯
   # tmux attach -t stock_updater é‡æ–°è¿æ¥
   ```

5. **å¤œé—´è¿è¡Œ**: é¿å¼€äº¤æ˜“æ—¶æ®µï¼Œå‡å°‘APIå‹åŠ›
   ```bash
   # ä½¿ç”¨ cron å®šæ—¶ä»»åŠ¡
   0 2 * * * cd /path/to/project && python data_updater_robust.py
   ```
