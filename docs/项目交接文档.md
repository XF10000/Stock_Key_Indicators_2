# 项目交接文档

## 1. 项目概述

-   **项目名称**: A股关键指标分析工具
-   **目标**: 构建一个本地化运行的命令行工具，用于获取、分析和可视化A股上市公司的关键财务指标，帮助用户进行基本面研究。
-   **核心功能**:
    1.  从网络（通过 `akshare`）自动获取并更新上市公司的财务报表数据到本地数据库。
    2.  根据预设公式计算多项关键财务指标（如 ROE、毛利率等）。
    3.  为指定股票生成指标趋势图，并与全市场中位数进行对比。

## 2. 系统架构

-   **架构模式**: 采用经典的分层架构，实现了表现层、应用层、业务逻辑层、数据访问层和数据存储层的清晰分离。
-   **核心模块**:
    -   `data_updater.py`: 独立的数据更新程序。
    -   `main.py`: 主分析程序。
    -   `orchestrator.py`: 应用层调度器。
    -   `data_provider/`: 数据访问层。
    -   `analysis/`: 业务逻辑层。
    -   `visualization/`: 可视化层。
    -   `models.py`: 数据模型层。

## 3. 技术栈

-   **编程语言**: Python 3.10+
-   **数据处理**: Pandas
-   **数据库**: SQLite
-   **数据库交互**: SQLAlchemy (ORM)
-   **数据获取**: Akshare
-   **数据可视化**: Matplotlib
-   **测试框架**: Pytest
-   **代码质量**: Black, Flake8, Mypy

## 4. 环境设置

1.  **克隆项目**:
    ```bash
    git clone <repository_url>
    cd <project_directory>
    ```

2.  **创建虚拟环境**:
    ```bash
    python -m venv venv
    source venv/bin/activate  # On Windows, use `venv\Scripts\activate`
    ```

3.  **安装依赖**:
    ```bash
    pip install -r requirements.txt
    ```

## 5. 项目运行指南

1.  **第一步：初始化数据库 (必须)**
    -   **命令**: `python data_updater.py`
    -   **作用**: 获取所有 A 股公司的历史财务数据并存入本地数据库。首次运行会非常耗时。
    -   **注意**: 程序支持断点续传。可以随时中断，下次运行时会自动从断点继续。
    -   **测试运行**: `python data_updater.py --limit 10` (仅更新10只股票，用于快速测试)。

2.  **第二步：运行分析**
    -   **命令**: `python main.py --code <stock_code>`
    -   **示例**: `python main.py --code SH600519`
    -   **作用**: 对指定的股票执行分析，并生成图表到 `output/` 目录。

## 6. 测试指南

-   **运行所有测试**:
    ```bash
    pytest
    ```
-   **运行特定文件的测试**:
    ```bash
    pytest tests/unit/test_calculator.py
    ```

## 7. 代码导览与维护指南

### 7.1 `data_updater.py`

-   **职责**: 负责填充和更新本地数据库，是所有分析的基础。
-   **维护指南**: 如果需要更换数据源（如从 `akshare` 换到其他 API），主要修改 `AkshareClient` 类即可。

### 7.2 `analysis/calculator.py`

-   **职责**: 包含所有财务指标的纯计算逻辑。
-   **维护指南**: 新增指标时，在此类中添加新的计算方法，并在 `tests/unit/test_calculator.py` 中为新方法添加单元测试。

### 7.3 `config/column_mapping.yaml`

-   **职责**: 用于将从 API 获取的原始列名映射到内部标准名称。
-   **维护指南**: 当日志中报告发现未映射的列名时，应在此文件中添加新的映射规则。

## 8. 待确认事项

-   无
